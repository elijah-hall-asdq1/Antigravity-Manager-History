
import requests
import json
import os
import sys
import datetime

# é…ç½®
REPO_OWNER = "lbjlaq"
REPO_NAME = "Antigravity-Manager"
GITHUB_API_URL = f"https://api.github.com/repos/{REPO_OWNER}/{REPO_NAME}/releases"
GITHUB_TOKEN = os.environ.get("GITHUB_TOKEN") # è‡ªåŠ¨è·å– Token é˜²æ­¢é€Ÿç‡é™åˆ¶

def get_headers():
    headers = {
        "Accept": "application/vnd.github.v3+json",
        "User-Agent": "Antigravity-Release-Monitor"
    }
    if GITHUB_TOKEN:
        headers["Authorization"] = f"token {GITHUB_TOKEN}"
    return headers

def è·å–æ‰€æœ‰ç‰ˆæœ¬():
    """è·å–æ‰€æœ‰ Release ä¿¡æ¯"""
    releases = []
    page = 1
    while True:
        url = f"{GITHUB_API_URL}?per_page=100&page={page}"
        try:
            r = requests.get(url, headers=get_headers(), timeout=30)
            if r.status_code == 404:
                break
            r.raise_for_status()
            data = r.json()
            if not data:
                break
            releases.extend(data)
            page += 1
        except Exception as e:
            print(f"è·å–ç‰ˆæœ¬åˆ—è¡¨å¤±è´¥: {e}", file=sys.stderr)
            break
    return releases

def è·å–æœ€æ–°ç‰ˆæœ¬():
    """è·å–æœ€æ–° Release"""
    url = f"{GITHUB_API_URL}/latest"
    try:
        r = requests.get(url, headers=get_headers(), timeout=30)
        if r.status_code == 404:
            # å°è¯•è·å–åˆ—è¡¨ç¬¬ä¸€ä¸ª
            all_releases = è·å–æ‰€æœ‰ç‰ˆæœ¬()
            if all_releases:
                return all_releases[0]
            return None
        r.raise_for_status()
        return r.json()
    except Exception as e:
        print(f"è·å–æœ€æ–°ç‰ˆæœ¬å¤±è´¥: {e}")
        return None

def ä¸‹è½½èµ„æº(assets, download_dir="."):
    """ä¸‹è½½ Release ä¸­çš„æ‰€æœ‰èµ„æº"""
    downloaded_files = []
    if not os.path.exists(download_dir):
        os.makedirs(download_dir)
        
    for asset in assets:
        name = asset["name"]
        url = asset["browser_download_url"]
        path = os.path.join(download_dir, name)
        print(f"æ­£åœ¨ä¸‹è½½: {name} ...")
        
        try:
            with requests.get(url, stream=True, timeout=300) as r:
                r.raise_for_status()
                with open(path, 'wb') as f:
                    for chunk in r.iter_content(chunk_size=8192):
                        f.write(chunk)
            downloaded_files.append(name)
            print(f"ä¸‹è½½å®Œæˆ: {name}")
        except Exception as e:
            print(f"ä¸‹è½½å¤±è´¥ {name}: {e}")
            
    return downloaded_files

def åŠ è½½å†å²è®°å½•():
    if os.path.exists("history.json"):
        try:
            with open("history.json", "r", encoding="utf-8") as f:
                return json.load(f)
        except:
            pass
    return []

def ä¿å­˜å†å²è®°å½•(history):
    with open("history.json", "w", encoding="utf-8") as f:
        json.dump(history, f, indent=4, ensure_ascii=False)

def ç”ŸæˆREADME(history):
    # æŒ‰ç…§å‘å¸ƒæ—¶é—´å€’åº
    history.sort(key=lambda x: x.get("published_at", ""), reverse=True)
    
    current_time = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    latest = history[0] if history else {"tag_name": "Unknown", "published_at": "Unknown"}
    
    md = f"""# {REPO_NAME} è‡ªåŠ¨å¤‡ä»½ç›‘æ§

> [!TIP]
> æœ¬ä»“åº“è‡ªåŠ¨ç›‘æ§å¹¶å¤‡ä»½ [{REPO_OWNER}/{REPO_NAME}](https://github.com/{REPO_OWNER}/{REPO_NAME}) çš„ Release ç‰ˆæœ¬ã€‚
> æ¯å°æ—¶åŒæ­¥ä¸€æ¬¡ã€‚

## ğŸŒŸ æœ€æ–°ç‰ˆæœ¬: `{latest.get('tag_name', 'N/A')}`
**æ›´æ–°æ—¶é—´**: `{latest.get('published_at', current_time)}`

## ğŸ“œ å†å²ç‰ˆæœ¬å­˜æ¡£
| ç‰ˆæœ¬ | å‘å¸ƒæ—¶é—´ | èµ„æºæ–‡ä»¶ | åŸå§‹é“¾æ¥ |
| :--- | :--- | :--- | :--- |
"""
    
    for item in history:
        tag = item.get("tag_name", "N/A")
        date = item.get("published_at", "").split("T")[0]
        url = item.get("html_url", "#")
        
        # ç®€å•åˆ—å‡ºèµ„äº§
        assets_text = ""
        if "assets" in item:
            for asset in item["assets"]:
                # ä½¿ç”¨ release ç›´æ¥ä¸‹è½½é“¾æ¥ï¼ˆå¦‚æœå·²åœ¨ GitHub Release ä¸­æ‰˜ç®¡ï¼‰
                # è¿™é‡Œå‡è®¾æˆ‘ä»¬ä¼šä¸Šä¼ åˆ°å½“å‰çš„ Releaseï¼Œæ‰€ä»¥é“¾æ¥åº”è¯¥æŒ‡å‘å½“å‰ Repo çš„ Release
                # ä½†ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬å…ˆåˆ—å‡ºæ–‡ä»¶å
                assets_text += f"`{asset['name']}`<br>"
        
        md += f"| `{tag}` | {date} | {assets_text} | [Source]({url}) |\n"

    md += "\n---\n*Auto-generated by Antigravity Monitoring System*\n"
    return md

def main():
    # å‘½ä»¤è¡Œæ¨¡å¼
    if len(sys.argv) > 1:
        if sys.argv[1] == "--api-history":
            # è¿”å›æ‰€æœ‰ç‰ˆæœ¬åˆ—è¡¨ä¾› Matrix ä½¿ç”¨
            releases = è·å–æ‰€æœ‰ç‰ˆæœ¬()
            output = []
            for r in releases:
                # ç®€åŒ–æ•°æ®ç»“æ„ä»¥å‡å° JSON å¤§å°
                output.append({
                    "version": r["tag_name"],
                    "id": r["id"],
                    "assets": r["assets"], # åŒ…å« url ç­‰ä¿¡æ¯
                    "body": r["body"],
                    "published_at": r["published_at"],
                    "html_url": r["html_url"]
                })
            print(json.dumps(output))
            return

        if sys.argv[1] == "--download":
            # ä¸‹è½½æŒ‡å®šç‰ˆæœ¬çš„èµ„æº
            # ç”¨æ³•: python check_version.py --download <json_string_of_assets>
            # æˆ–è€…ä¸ºäº†ç®€å•ï¼Œé‡æ–°è·å–æŒ‡å®šç‰ˆæœ¬
            version_tag = sys.argv[2]
            print(f"æ­£åœ¨æŸ¥æ‰¾ç‰ˆæœ¬ {version_tag} çš„èµ„æº...")
            releases = è·å–æ‰€æœ‰ç‰ˆæœ¬()
            target_release = next((r for r in releases if r["tag_name"] == version_tag), None)
            
            if target_release:
                file_list = ä¸‹è½½èµ„æº(target_release["assets"])
                # å†™å…¥ step output
                if "GITHUB_OUTPUT" in os.environ:
                    with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                        f.write(f"assets={' '.join(file_list)}\n")
            else:
                print(f"æœªæ‰¾åˆ°ç‰ˆæœ¬ {version_tag}")
                sys.exit(1)
            return

    # é»˜è®¤æ¨¡å¼ï¼šæ£€æŸ¥æ›´æ–° (Hourly Job)
    print("å¼€å§‹æ£€æŸ¥æœ€æ–°ç‰ˆæœ¬...")
    latest_release = è·å–æœ€æ–°ç‰ˆæœ¬()
    if not latest_release:
        print("æ— æ³•è·å–æœ€æ–°ç‰ˆæœ¬")
        sys.exit(1)

    tag_name = latest_release["tag_name"]
    published_at = latest_release["published_at"]
    
    # è¯»å–æœ¬åœ°ç‰ˆæœ¬
    local_version = ""
    if os.path.exists("VERSION"):
        with open("VERSION", "r", encoding="utf-8") as f:
            local_version = f.read().strip()
            
    print(f"æœ¬åœ°ç‰ˆæœ¬: {local_version}, è¿œç¨‹æœ€æ–°: {tag_name}")
    
    # åªæœ‰å½“ç‰ˆæœ¬ä¸åŒæ—¶æ‰è§¦å‘åŠ¨ä½œ
    version_changed = (tag_name != local_version)
    
    # æ›´æ–°å†å²è®°å½• (æ— è®ºæ˜¯å¦å˜åŒ–ï¼Œéƒ½ç¡®ä¿å†å²è®°å½•æ˜¯æœ€æ–°çš„)
    history = åŠ è½½å†å²è®°å½•()
    # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    exists = any(item["tag_name"] == tag_name for item in history)
    if not exists:
        history.insert(0, {
            "tag_name": tag_name,
            "published_at": published_at,
            "html_url": latest_release["html_url"],
            "assets": [{"name": a["name"], "browser_download_url": a["browser_download_url"]} for a in latest_release["assets"]]
        })
        ä¿å­˜å†å²è®°å½•(history)
    
    readme_content = ç”ŸæˆREADME(history)
    with open("README.md", "w", encoding="utf-8") as f:
        f.write(readme_content)
        
    # å†™å…¥ Output
    if "GITHUB_OUTPUT" in os.environ:
        with open(os.environ["GITHUB_OUTPUT"], "a") as f:
            f.write(f"version_changed={'true' if version_changed else 'false'}\n")
            f.write(f"version={tag_name}\n")
            f.write(f"body={json.dumps(latest_release['body'])}\n") # é˜²æ­¢å¤šè¡Œé—®é¢˜ï¼Œè™½ç„¶json.dumpsä¼šè½¬ä¹‰
            
            if version_changed:
                print("ç‰ˆæœ¬æ›´æ–°ï¼Œå¼€å§‹ä¸‹è½½èµ„æº...")
                file_list = ä¸‹è½½èµ„æº(latest_release["assets"])
                f.write(f"assets={' '.join(file_list)}\n")
                
                # æ›´æ–°æœ¬åœ° VERSION æ–‡ä»¶
                with open("VERSION", "w", encoding="utf-8") as vf:
                    vf.write(tag_name)

if __name__ == "__main__":
    main()
